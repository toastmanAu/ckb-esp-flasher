<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CKB ESP Flasher â€” Theme Builder</title>
  <style>
    :root {
      --bg:      #0d0d0d;
      --panel:   #161616;
      --border:  #2a2a2a;
      --accent:  #f0a500;
      --accent2: #00c896;
      --text:    #e8e8e8;
      --dim:     #888;
      --warn:    #e05a00;
      --radius:  10px;
      --font:    'Segoe UI', system-ui, sans-serif;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font);
      min-height: 100vh;
    }

    /* â”€â”€ HEADER â”€â”€ */
    header {
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      padding: 18px 32px;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    header .logo { font-size: 22px; font-weight: 700; letter-spacing: -0.5px; }
    header .logo span { color: var(--accent); }
    header nav { margin-left: auto; display: flex; gap: 8px; }
    header nav a {
      color: var(--dim);
      text-decoration: none;
      padding: 6px 14px;
      border-radius: 6px;
      font-size: 14px;
      transition: background 0.15s, color 0.15s;
    }
    header nav a:hover, header nav a.active { background: var(--border); color: var(--text); }
    header nav a.active { color: var(--accent); }

    /* â”€â”€ LAYOUT â”€â”€ */
    .container {
      max-width: 960px;
      margin: 0 auto;
      padding: 40px 24px 80px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 32px;
      align-items: start;
    }
    @media (max-width: 700px) {
      .container { grid-template-columns: 1fr; }
    }

    h1 { font-size: 26px; font-weight: 700; margin-bottom: 6px; }
    h1 span { color: var(--accent); }
    .subtitle { color: var(--dim); font-size: 14px; line-height: 1.6; margin-bottom: 28px; }

    /* â”€â”€ FORM â”€â”€ */
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
    }
    .card h2 { font-size: 15px; color: var(--accent); margin-bottom: 18px; text-transform: uppercase; letter-spacing: 0.05em; }

    .field { margin-bottom: 16px; }
    .field label { display: block; font-size: 13px; color: var(--dim); margin-bottom: 6px; }
    .field input[type=text],
    .field input[type=password] {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 14px;
      padding: 9px 12px;
      outline: none;
      transition: border-color 0.15s;
    }
    .field input:focus { border-color: var(--accent); }

    .colour-row { display: flex; align-items: center; gap: 10px; }
    .colour-row input[type=color] {
      width: 44px; height: 36px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--bg);
      cursor: pointer;
      padding: 2px;
    }
    .colour-row input[type=text] { flex: 1; }

    .divider {
      border: none;
      border-top: 1px solid var(--border);
      margin: 20px 0;
    }

    /* â”€â”€ BUTTON â”€â”€ */
    .btn {
      display: block;
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 7px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.15s;
    }
    .btn-primary { background: var(--accent); color: #000; }
    .btn-primary:hover { opacity: 0.88; }
    .btn-primary:disabled { background: var(--border); color: var(--dim); cursor: not-allowed; opacity: 1; }

    /* â”€â”€ STATUS LOG â”€â”€ */
    .log {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 12px;
      font-family: monospace;
      font-size: 13px;
      color: var(--accent2);
      min-height: 80px;
      max-height: 160px;
      overflow-y: auto;
      margin-top: 16px;
      white-space: pre-wrap;
    }
    .log .err { color: var(--warn); }
    .log .ok  { color: var(--accent2); }
    .log .dim { color: var(--dim); }

    /* â”€â”€ PREVIEW â”€â”€ */
    .preview-wrap { position: sticky; top: 24px; }
    .preview-label { font-size: 13px; color: var(--dim); margin-bottom: 10px; }

    .preview {
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid var(--border);
      font-family: monospace;
      font-size: 11px;
    }
    .preview .p-header {
      padding: 10px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .preview .p-header .p-title { font-weight: 700; font-size: 13px; color: #000; }
    .preview .p-dot { width: 12px; height: 12px; border-radius: 50%; background: #27c34c; border: 2px solid #000; }
    .preview .p-body { padding: 12px 14px; }
    .preview .p-label { color: #888; font-size: 10px; margin-bottom: 2px; }
    .preview .p-number { font-size: 22px; font-weight: 700; letter-spacing: 1px; margin-bottom: 10px; }
    .preview .p-row { display: flex; gap: 12px; margin-bottom: 8px; }
    .preview .p-stat { flex: 1; }
    .preview .p-bar-wrap { background: #333; border-radius: 4px; height: 8px; margin-top: 4px; overflow: hidden; }
    .preview .p-bar { height: 100%; border-radius: 4px; width: 67%; }

    /* â”€â”€ HOW IT WORKS (compact) â”€â”€ */
    .how-note {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px 20px;
      margin-top: 20px;
      font-size: 13px;
      color: var(--dim);
      line-height: 1.7;
    }
    .how-note strong { color: var(--text); }
    .how-note code { color: var(--accent2); background: var(--bg); padding: 1px 5px; border-radius: 3px; }

    /* â”€â”€ BROWSER WARN â”€â”€ */
    .browser-note {
      text-align: center;
      color: var(--warn);
      font-size: 13px;
      padding: 16px 24px 0;
    }
  </style>
</head>
<body>

<header>
  <div class="logo"><span>CKB</span> ESP Flasher</div>
  <nav>
    <a href="index.html">Flash</a>
    <a href="theme.html" class="active">Theme Builder</a>
    <a href="buy.html">Where to Buy</a>
  </nav>
</header>

<script>
  if (!navigator.serial) {
    document.write('<p class="browser-note">âš ï¸ Web Serial requires <strong>Chrome or Edge</strong> on desktop.</p>');
  }
</script>

<div class="container">

  <!-- LEFT: form -->
  <div>
    <h1>Theme <span>Builder</span></h1>
    <p class="subtitle">Configure your CKB dashboard without reflashing. Plug in via USB, fill in the form, and send â€” device reboots with your settings.</p>
    <p style="color:#00c896;font-size:13px;margin-bottom:8px;">ğŸ“± Works on Android â€” Chrome + USB OTG adapter, no PC needed.</p>

    <!-- Board detection banner -->
    <div id="boardBanner" style="display:none;margin-bottom:16px;padding:10px 14px;border-radius:8px;font-size:13px;font-weight:600;border:1px solid var(--border);">
      <span id="boardBannerText"></span>
    </div>
    <button class="btn" id="detectBtn" onclick="detectBoard()"
      style="margin-bottom:16px;background:var(--panel);border:1px solid var(--border);color:var(--text);padding:8px 18px;border-radius:8px;cursor:pointer;font-size:13px;">
      ğŸ”Œ Detect Board
    </button>

    <div class="card">
      <h2>Network</h2>

      <div class="field">
        <label>WiFi SSID</label>
        <input type="text" id="wifi_ssid" placeholder="Your network name" autocomplete="off" />
      </div>
      <div class="field">
        <label>WiFi Password</label>
        <input type="password" id="wifi_pass" placeholder="Leave blank to keep existing" autocomplete="off" />
      </div>
      <div class="field">
        <label>CKB Node URL</label>
        <input type="text" id="node_url" placeholder="http://192.168.1.x:8114" />
        <p style="color:var(--dim);font-size:11px;margin-top:4px;">Public endpoint: <code style="color:var(--accent2)">https://mainnet.ckbapp.dev</code> â€” no local node needed</p>
      </div>

      <hr class="divider" />
      <h2>Colours</h2>

      <div class="field">
        <label>Accent colour</label>
        <div class="colour-row">
          <input type="color" id="accent_picker" value="#ff6800" />
          <input type="text"  id="accent_hex"    value="#ff6800" maxlength="7" />
        </div>
      </div>
      <div class="field">
        <label>Background colour</label>
        <div class="colour-row">
          <input type="color" id="bg_picker" value="#101020" />
          <input type="text"  id="bg_hex"    value="#101020" maxlength="7" />
        </div>
      </div>

      <hr class="divider" />

      <!-- Theme not supported message (hidden by default) -->
      <div id="noThemeMsg" style="display:none;padding:12px 14px;background:#1a0a00;border:1px solid #e05a00;border-radius:8px;color:#e05a00;font-size:13px;margin-bottom:12px;">
        âš ï¸ Theme Builder is not supported for this board. Flash and use as-is, or connect a supported board (Guition 4848S040, JC3248W535EN).
      </div>

      <button class="btn btn-primary" id="sendBtn" onclick="sendConfig()">
        Connect &amp; Send Config
      </button>

      <div class="log" id="log"><span class="dim">Ready. Fill in the fields above then click Connect &amp; Send.</span></div>
    </div>

    <div class="how-note">
      <strong>How it works:</strong> On every boot the firmware listens on USB serial for <strong>3 seconds</strong>.
      When you click Connect &amp; Send, the browser opens a serial connection and sends <code>CKBCFG</code>.
      The device responds <code>READY:board_id</code> (auto-detected), receives your settings as JSON, writes them to flash, and reboots.
      Only fields you fill in are updated â€” blank fields keep their existing values.
    </div>
  </div>

  <!-- RIGHT: live preview -->
  <div class="preview-wrap">
    <p class="preview-label">Live preview</p>
    <div class="preview" id="preview">
      <div class="p-header" id="prev-header" style="background:#ff6800;">
        <span class="p-title">CKB NODE</span>
        <span class="p-dot"></span>
      </div>
      <div class="p-body" id="prev-body" style="background:#101020;">
        <div class="p-label">block height</div>
        <div class="p-number" id="prev-accent" style="color:#ff6800;">18,709,215</div>
        <div class="p-row">
          <div class="p-stat">
            <div class="p-label">Peers</div>
            <div style="color:#27c34c;font-size:16px;font-weight:700;">21</div>
          </div>
          <div class="p-stat">
            <div class="p-label">Mempool</div>
            <div style="color:#e8e8e8;font-size:16px;font-weight:700;">14 TX</div>
          </div>
        </div>
        <div class="p-label" style="margin-top:4px;">Epoch 3142 &nbsp; 67%</div>
        <div class="p-bar-wrap">
          <div class="p-bar" id="prev-bar" style="background:#ff6800;"></div>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
  /* â”€â”€ Colour sync â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function hexToRgb(hex) {
    const r = parseInt(hex.slice(1,3),16);
    const g = parseInt(hex.slice(3,5),16);
    const b = parseInt(hex.slice(5,7),16);
    return {r,g,b};
  }

  function syncColour(pickerId, hexId, previewFn) {
    const picker = document.getElementById(pickerId);
    const hex    = document.getElementById(hexId);
    picker.addEventListener('input', () => { hex.value = picker.value; previewFn(picker.value); });
    hex.addEventListener('input', () => {
      if (/^#[0-9a-fA-F]{6}$/.test(hex.value)) {
        picker.value = hex.value;
        previewFn(hex.value);
      }
    });
  }

  syncColour('accent_picker','accent_hex', v => {
    document.getElementById('prev-header').style.background = v;
    document.getElementById('prev-accent').style.color = v;
    document.getElementById('prev-bar').style.background = v;
  });
  syncColour('bg_picker','bg_hex', v => {
    document.getElementById('prev-body').style.background = v;
  });

  /* â”€â”€ Log helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const logEl = document.getElementById('log');
  function log(msg, cls='') {
    logEl.innerHTML += `<span class="${cls}">${msg}\n</span>`;
    logEl.scrollTop = logEl.scrollHeight;
  }
  function logClear() { logEl.innerHTML = ''; }

  /* â”€â”€ Build JSON payload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function buildJson() {
    const obj = {};
    const ssid     = document.getElementById('wifi_ssid').value.trim();
    const pass     = document.getElementById('wifi_pass').value;
    const node_url = document.getElementById('node_url').value.trim();
    const accent   = hexToRgb(document.getElementById('accent_hex').value);
    const bg       = hexToRgb(document.getElementById('bg_hex').value);

    if (ssid)     obj.wifi_ssid = ssid;
    if (pass)     obj.wifi_pass = pass;
    if (node_url) obj.node_url  = node_url;

    obj.accent_r = accent.r; obj.accent_g = accent.g; obj.accent_b = accent.b;
    obj.bg_r     = bg.r;     obj.bg_g     = bg.g;     obj.bg_b     = bg.b;

    return JSON.stringify(obj);
  }

  /* â”€â”€ Board detection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  const THEME_SUPPORTED = ['guition4848', 'jc3248w535en', 'stratum-hmi'];
  let detectedBoard = null;

  const boardNames = {
    'guition4848':   'Guition ESP32-S3 4848S040',
    'jc3248w535en':  'JCZN JC3248W535EN',
    'stratum-hmi':   'CKB Stratum Proxy HMI',
  };

  function setBoardUI(boardId) {
    detectedBoard = boardId;
    const banner = document.getElementById('boardBanner');
    const bannerText = document.getElementById('boardBannerText');
    const noThemeMsg = document.getElementById('noThemeMsg');
    const sendBtn = document.getElementById('sendBtn');

    banner.style.display = 'block';

    if (boardId && THEME_SUPPORTED.includes(boardId)) {
      const name = boardNames[boardId] || boardId;
      banner.style.background = '#001a0f';
      banner.style.borderColor = '#00c896';
      banner.style.color = '#00c896';
      bannerText.textContent = 'âœ… Detected: ' + name + ' â€” Theme Builder supported';
      noThemeMsg.style.display = 'none';
      sendBtn.disabled = false;
    } else if (boardId) {
      banner.style.background = '#1a0a00';
      banner.style.borderColor = '#e05a00';
      banner.style.color = '#e05a00';
      bannerText.textContent = 'âš ï¸ Detected: ' + (boardNames[boardId] || boardId) + ' â€” Theme Builder not supported for this board';
      noThemeMsg.style.display = 'block';
      sendBtn.disabled = true;
    } else {
      banner.style.background = '#1a1a00';
      banner.style.borderColor = '#888';
      banner.style.color = '#888';
      bannerText.textContent = 'â“ Unknown board â€” could not identify device';
      noThemeMsg.style.display = 'none';
      sendBtn.disabled = false;
    }
  }

  async function detectBoard() {
    if (!navigator.serial) {
      alert('Web Serial not supported. Use Chrome or Edge.');
      return;
    }
    const btn = document.getElementById('detectBtn');
    btn.textContent = 'â³ Detectingâ€¦';
    btn.disabled = true;
    let port;
    try {
      port = await navigator.serial.requestPort();
      await port.open({ baudRate: 115200 });

      const decoder = new TextDecoderStream();
      port.readable.pipeTo(decoder.writable);
      const reader = decoder.readable.getReader();
      const writer = port.writable.getWriter();

      async function readLine(timeoutMs = 5000) {
        let buf = '';
        const deadline = Date.now() + timeoutMs;
        while (Date.now() < deadline) {
          const { value, done } = await Promise.race([
            reader.read(),
            new Promise((_,r) => setTimeout(() => r(new Error('timeout')), 200))
          ]).catch(() => ({ value: null, done: false }));
          if (done || value === null) continue;
          buf += value;
          const nl = buf.indexOf('\n');
          if (nl !== -1) return buf.slice(0, nl).trim();
        }
        throw new Error('Read timeout');
      }

      // Send CKBCFG and parse READY:<board_id>
      await writer.write(new TextEncoder().encode('CKBCFG\n'));
      const resp = await readLine(6000);
      writer.releaseLock();
      reader.cancel();

      if (resp.startsWith('READY')) {
        const parts = resp.split(':');
        const boardId = parts.length > 1 ? parts[1].trim() : null;
        setBoardUI(boardId);
        // Pre-fill detected port for sendConfig reuse
        window._detectedPort = null; // port will close; user re-selects on send
      } else {
        setBoardUI(null);
      }
    } catch(e) {
      document.getElementById('boardBanner').style.display = 'block';
      document.getElementById('boardBannerText').textContent = 'âŒ Detection failed: ' + e.message;
      document.getElementById('boardBanner').style.color = '#e05a00';
      document.getElementById('boardBanner').style.borderColor = '#e05a00';
      document.getElementById('boardBanner').style.background = '#1a0a00';
    } finally {
      try { port && await port.close(); } catch(_) {}
      btn.textContent = 'ğŸ”Œ Detect Board';
      btn.disabled = false;
    }
  }

  /* â”€â”€ WebSerial send â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  async function sendConfig() {
    if (!navigator.serial) {
      log('âŒ Web Serial not supported. Use Chrome/Edge on desktop, or Chrome on Android with USB OTG.', 'err');
      return;
    }

    const btn = document.getElementById('sendBtn');
    btn.disabled = true;
    logClear();

    let port, writer, reader;
    try {
      log('Requesting serial portâ€¦', 'dim');
      port = await navigator.serial.requestPort();
      await port.open({ baudRate: 115200 });
      log('Port opened âœ“', 'ok');

      writer = port.writable.getWriter();
      const decoder = new TextDecoderStream();
      port.readable.pipeTo(decoder.writable);
      reader = decoder.readable.getReader();

      /* Helper: read lines with timeout */
      async function readLine(timeoutMs = 5000) {
        let buf = '';
        const deadline = Date.now() + timeoutMs;
        while (Date.now() < deadline) {
          const { value, done } = await Promise.race([
            reader.read(),
            new Promise((_,r) => setTimeout(() => r(new Error('timeout')), 200))
          ]).catch(() => ({ value: null, done: false }));
          if (done || value === null) continue;
          buf += value;
          const nl = buf.indexOf('\n');
          if (nl !== -1) return buf.slice(0, nl).trim();
        }
        throw new Error('Read timeout');
      }

      /* Helper: write string */
      async function write(str) {
        await writer.write(new TextEncoder().encode(str));
      }

      log('Sending handshakeâ€¦', 'dim');
      await write('CKBCFG\n');

      log('Waiting for READYâ€¦', 'dim');
      const resp = await readLine(5000);
      if (!resp.startsWith('READY')) throw new Error(`Unexpected response: "${resp}". Is firmware loaded and 3s window still open?`);
      // Parse board ID from READY:<board_id>
      const readyParts = resp.split(':');
      if (readyParts.length > 1) {
        setBoardUI(readyParts[1].trim());
        if (!THEME_SUPPORTED.includes(readyParts[1].trim())) {
          throw new Error('Theme Builder not supported for board: ' + readyParts[1].trim());
        }
      }
      log('Device ready âœ“' + (readyParts[1] ? ' [' + (boardNames[readyParts[1].trim()] || readyParts[1].trim()) + ']' : ''), 'ok');

      const payload = buildJson();
      log(`Sending: ${payload}`, 'dim');
      await write(payload + '\nEND\n');

      log('Waiting for OKâ€¦', 'dim');
      const ok = await readLine(5000);
      if (ok !== 'OK') throw new Error(`Expected OK, got: "${ok}"`);

      log('âœ… Config saved! Device is rebootingâ€¦', 'ok');

    } catch(e) {
      log(`âŒ ${e.message}`, 'err');
    } finally {
      try { writer && writer.releaseLock(); } catch(_) {}
      try { reader && reader.cancel(); } catch(_) {}
      try { port  && await port.close(); } catch(_) {}
      btn.disabled = false;
    }
  }
</script>

</body>
</html>
