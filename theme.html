<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CKB ESP Flasher — Theme Builder</title>
  <style>
    :root {
      --bg:      #0d0d0d;
      --panel:   #161616;
      --border:  #2a2a2a;
      --accent:  #f0a500;
      --accent2: #00c896;
      --text:    #e8e8e8;
      --dim:     #888;
      --warn:    #e05a00;
      --radius:  10px;
      --font:    'Segoe UI', system-ui, sans-serif;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font);
      min-height: 100vh;
    }

    /* ── HEADER ── */
    header {
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      padding: 18px 32px;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    header .logo { font-size: 22px; font-weight: 700; letter-spacing: -0.5px; }
    header .logo span { color: var(--accent); }
    header nav { margin-left: auto; display: flex; gap: 8px; }
    header nav a {
      color: var(--dim);
      text-decoration: none;
      padding: 6px 14px;
      border-radius: 6px;
      font-size: 14px;
      transition: background 0.15s, color 0.15s;
    }
    header nav a:hover, header nav a.active { background: var(--border); color: var(--text); }
    header nav a.active { color: var(--accent); }

    /* ── LAYOUT ── */
    .container {
      max-width: 960px;
      margin: 0 auto;
      padding: 40px 24px 80px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 32px;
      align-items: start;
    }
    @media (max-width: 700px) {
      .container { grid-template-columns: 1fr; }
    }

    h1 { font-size: 26px; font-weight: 700; margin-bottom: 6px; }
    h1 span { color: var(--accent); }
    .subtitle { color: var(--dim); font-size: 14px; line-height: 1.6; margin-bottom: 28px; }

    /* ── FORM ── */
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
    }
    .card h2 { font-size: 15px; color: var(--accent); margin-bottom: 18px; text-transform: uppercase; letter-spacing: 0.05em; }

    .field { margin-bottom: 16px; }
    .field label { display: block; font-size: 13px; color: var(--dim); margin-bottom: 6px; }
    .field input[type=text],
    .field input[type=password] {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 14px;
      padding: 9px 12px;
      outline: none;
      transition: border-color 0.15s;
    }
    .field input:focus { border-color: var(--accent); }

    .colour-row { display: flex; align-items: center; gap: 10px; }
    .colour-row input[type=color] {
      width: 44px; height: 36px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--bg);
      cursor: pointer;
      padding: 2px;
    }
    .colour-row input[type=text] { flex: 1; }

    .divider {
      border: none;
      border-top: 1px solid var(--border);
      margin: 20px 0;
    }

    /* ── BUTTON ── */
    .btn {
      display: block;
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 7px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.15s;
    }
    .btn-primary { background: var(--accent); color: #000; }
    .btn-primary:hover { opacity: 0.88; }
    .btn-primary:disabled { background: var(--border); color: var(--dim); cursor: not-allowed; opacity: 1; }

    /* ── STATUS LOG ── */
    .log {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 12px;
      font-family: monospace;
      font-size: 13px;
      color: var(--accent2);
      min-height: 80px;
      max-height: 160px;
      overflow-y: auto;
      margin-top: 16px;
      white-space: pre-wrap;
    }
    .log .err { color: var(--warn); }
    .log .ok  { color: var(--accent2); }
    .log .dim { color: var(--dim); }

    /* ── PREVIEW ── */
    .preview-wrap { position: sticky; top: 24px; }
    .preview-label { font-size: 13px; color: var(--dim); margin-bottom: 10px; }

    .preview {
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid var(--border);
      font-family: monospace;
      font-size: 11px;
    }
    .preview .p-header {
      padding: 10px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .preview .p-header .p-title { font-weight: 700; font-size: 13px; color: #000; }
    .preview .p-dot { width: 12px; height: 12px; border-radius: 50%; background: #27c34c; border: 2px solid #000; }
    .preview .p-body { padding: 12px 14px; }
    .preview .p-label { color: #888; font-size: 10px; margin-bottom: 2px; }
    .preview .p-number { font-size: 22px; font-weight: 700; letter-spacing: 1px; margin-bottom: 10px; }
    .preview .p-row { display: flex; gap: 12px; margin-bottom: 8px; }
    .preview .p-stat { flex: 1; }
    .preview .p-bar-wrap { background: #333; border-radius: 4px; height: 8px; margin-top: 4px; overflow: hidden; }
    .preview .p-bar { height: 100%; border-radius: 4px; width: 67%; }

    /* ── HOW IT WORKS (compact) ── */
    .how-note {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px 20px;
      margin-top: 20px;
      font-size: 13px;
      color: var(--dim);
      line-height: 1.7;
    }
    .how-note strong { color: var(--text); }
    .how-note code { color: var(--accent2); background: var(--bg); padding: 1px 5px; border-radius: 3px; }

    /* ── BROWSER WARN ── */
    .browser-note {
      text-align: center;
      color: var(--warn);
      font-size: 13px;
      padding: 16px 24px 0;
    }
  </style>
</head>
<body>

<header>
  <div class="logo"><span>CKB</span> ESP Flasher</div>
  <nav>
    <a href="index.html">Flash</a>
    <a href="theme.html" class="active">Theme Builder</a>
  </nav>
</header>

<script>
  if (!navigator.serial) {
    document.write('<p class="browser-note">⚠️ Web Serial requires <strong>Chrome or Edge</strong> on desktop.</p>');
  }
</script>

<div class="container">

  <!-- LEFT: form -->
  <div>
    <h1>Theme <span>Builder</span></h1>
    <p class="subtitle">Configure your CKB dashboard without reflashing. Plug in via USB, fill in the form, and send — device reboots with your settings.</p>

    <div class="card">
      <h2>Network</h2>

      <div class="field">
        <label>WiFi SSID</label>
        <input type="text" id="wifi_ssid" placeholder="Your network name" autocomplete="off" />
      </div>
      <div class="field">
        <label>WiFi Password</label>
        <input type="password" id="wifi_pass" placeholder="Leave blank to keep existing" autocomplete="off" />
      </div>
      <div class="field">
        <label>CKB Node URL</label>
        <input type="text" id="node_url" placeholder="http://192.168.1.x:8114" />
      </div>

      <hr class="divider" />
      <h2>Colours</h2>

      <div class="field">
        <label>Accent colour</label>
        <div class="colour-row">
          <input type="color" id="accent_picker" value="#ff6800" />
          <input type="text"  id="accent_hex"    value="#ff6800" maxlength="7" />
        </div>
      </div>
      <div class="field">
        <label>Background colour</label>
        <div class="colour-row">
          <input type="color" id="bg_picker" value="#101020" />
          <input type="text"  id="bg_hex"    value="#101020" maxlength="7" />
        </div>
      </div>

      <hr class="divider" />

      <button class="btn btn-primary" id="sendBtn" onclick="sendConfig()">
        Connect &amp; Send Config
      </button>

      <div class="log" id="log"><span class="dim">Ready. Fill in the fields above then click Connect &amp; Send.</span></div>
    </div>

    <div class="how-note">
      <strong>How it works:</strong> On every boot the firmware listens on USB serial for <strong>3 seconds</strong>.
      When you click Connect &amp; Send, the browser opens a serial connection and sends <code>CKBCFG</code>.
      The device responds <code>READY</code>, receives your settings as JSON, writes them to flash, and reboots.
      Only fields you fill in are updated — blank fields keep their existing values.
    </div>
  </div>

  <!-- RIGHT: live preview -->
  <div class="preview-wrap">
    <p class="preview-label">Live preview</p>
    <div class="preview" id="preview">
      <div class="p-header" id="prev-header" style="background:#ff6800;">
        <span class="p-title">CKB NODE</span>
        <span class="p-dot"></span>
      </div>
      <div class="p-body" id="prev-body" style="background:#101020;">
        <div class="p-label">block height</div>
        <div class="p-number" id="prev-accent" style="color:#ff6800;">18,709,215</div>
        <div class="p-row">
          <div class="p-stat">
            <div class="p-label">Peers</div>
            <div style="color:#27c34c;font-size:16px;font-weight:700;">21</div>
          </div>
          <div class="p-stat">
            <div class="p-label">Mempool</div>
            <div style="color:#e8e8e8;font-size:16px;font-weight:700;">14 TX</div>
          </div>
        </div>
        <div class="p-label" style="margin-top:4px;">Epoch 3142 &nbsp; 67%</div>
        <div class="p-bar-wrap">
          <div class="p-bar" id="prev-bar" style="background:#ff6800;"></div>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
  /* ── Colour sync ─────────────────────────────────────────── */
  function hexToRgb(hex) {
    const r = parseInt(hex.slice(1,3),16);
    const g = parseInt(hex.slice(3,5),16);
    const b = parseInt(hex.slice(5,7),16);
    return {r,g,b};
  }

  function syncColour(pickerId, hexId, previewFn) {
    const picker = document.getElementById(pickerId);
    const hex    = document.getElementById(hexId);
    picker.addEventListener('input', () => { hex.value = picker.value; previewFn(picker.value); });
    hex.addEventListener('input', () => {
      if (/^#[0-9a-fA-F]{6}$/.test(hex.value)) {
        picker.value = hex.value;
        previewFn(hex.value);
      }
    });
  }

  syncColour('accent_picker','accent_hex', v => {
    document.getElementById('prev-header').style.background = v;
    document.getElementById('prev-accent').style.color = v;
    document.getElementById('prev-bar').style.background = v;
  });
  syncColour('bg_picker','bg_hex', v => {
    document.getElementById('prev-body').style.background = v;
  });

  /* ── Log helper ──────────────────────────────────────────── */
  const logEl = document.getElementById('log');
  function log(msg, cls='') {
    logEl.innerHTML += `<span class="${cls}">${msg}\n</span>`;
    logEl.scrollTop = logEl.scrollHeight;
  }
  function logClear() { logEl.innerHTML = ''; }

  /* ── Build JSON payload ──────────────────────────────────── */
  function buildJson() {
    const obj = {};
    const ssid     = document.getElementById('wifi_ssid').value.trim();
    const pass     = document.getElementById('wifi_pass').value;
    const node_url = document.getElementById('node_url').value.trim();
    const accent   = hexToRgb(document.getElementById('accent_hex').value);
    const bg       = hexToRgb(document.getElementById('bg_hex').value);

    if (ssid)     obj.wifi_ssid = ssid;
    if (pass)     obj.wifi_pass = pass;
    if (node_url) obj.node_url  = node_url;

    obj.accent_r = accent.r; obj.accent_g = accent.g; obj.accent_b = accent.b;
    obj.bg_r     = bg.r;     obj.bg_g     = bg.g;     obj.bg_b     = bg.b;

    return JSON.stringify(obj);
  }

  /* ── WebSerial send ──────────────────────────────────────── */
  async function sendConfig() {
    if (!navigator.serial) {
      log('❌ Web Serial not supported. Use Chrome or Edge.', 'err');
      return;
    }

    const btn = document.getElementById('sendBtn');
    btn.disabled = true;
    logClear();

    let port, writer, reader;
    try {
      log('Requesting serial port…', 'dim');
      port = await navigator.serial.requestPort();
      await port.open({ baudRate: 115200 });
      log('Port opened ✓', 'ok');

      writer = port.writable.getWriter();
      const decoder = new TextDecoderStream();
      port.readable.pipeTo(decoder.writable);
      reader = decoder.readable.getReader();

      /* Helper: read lines with timeout */
      async function readLine(timeoutMs = 5000) {
        let buf = '';
        const deadline = Date.now() + timeoutMs;
        while (Date.now() < deadline) {
          const { value, done } = await Promise.race([
            reader.read(),
            new Promise((_,r) => setTimeout(() => r(new Error('timeout')), 200))
          ]).catch(() => ({ value: null, done: false }));
          if (done || value === null) continue;
          buf += value;
          const nl = buf.indexOf('\n');
          if (nl !== -1) return buf.slice(0, nl).trim();
        }
        throw new Error('Read timeout');
      }

      /* Helper: write string */
      async function write(str) {
        await writer.write(new TextEncoder().encode(str));
      }

      log('Sending handshake…', 'dim');
      await write('CKBCFG\n');

      log('Waiting for READY…', 'dim');
      const resp = await readLine(5000);
      if (resp !== 'READY') throw new Error(`Unexpected response: "${resp}". Is firmware loaded and 3s window still open?`);
      log('Device ready ✓', 'ok');

      const payload = buildJson();
      log(`Sending: ${payload}`, 'dim');
      await write(payload + '\nEND\n');

      log('Waiting for OK…', 'dim');
      const ok = await readLine(5000);
      if (ok !== 'OK') throw new Error(`Expected OK, got: "${ok}"`);

      log('✅ Config saved! Device is rebooting…', 'ok');

    } catch(e) {
      log(`❌ ${e.message}`, 'err');
    } finally {
      try { writer && writer.releaseLock(); } catch(_) {}
      try { reader && reader.cancel(); } catch(_) {}
      try { port  && await port.close(); } catch(_) {}
      btn.disabled = false;
    }
  }
</script>

</body>
</html>
